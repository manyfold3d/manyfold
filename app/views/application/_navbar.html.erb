<%= content_tag :nav, class: "navbar navbar-expand-md bg-primary", id: "main-navbar",
      data: {
        bs_theme: "dark"
      }.merge(tour_attributes(id: "main-navbar", title: t("tour.navbar.main.title", name: site_name), description: t("tour.navbar.main.description"))) do %>
  <div class='container-fluid'>
    <a class="navbar-brand ms-2" href="<%= root_path %>" aria-label="<%= translate ".home" %>">
      <%= image_tag site_icon, alt: site_name, height: "40px", class: "me-2" %>
      <span class="d-md-none"><%= site_name %></span>
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbarTogglerDemo01" aria-expanded="false" aria-label="<%= translate ".navbar.toggler.label" %>">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse row" id="navbar">
      <ul class="navbar-nav col ps-4 ps-md-0 align-self-start">
        <li class="nav-item">
          <%= nav_link "box", Model.model_name.human(count: 100), models_path(@filter&.to_params), text_style: "d-md-none d-lg-inline", id: "nav-link-models",
                data: tour_attributes(id: "nav-link-models", title: Model.model_name.human(count: 100), description: t("tour.navbar.models.description")) %>
        </li>
        <li class="nav-item">
          <%= nav_link "people", Creator.model_name.human(count: 100), creators_path(@filter&.to_params(except: :creator)), text_style: "d-md-none d-lg-inline", id: "nav-link-creators",
                data: tour_attributes(id: "nav-link-creators", title: Creator.model_name.human(count: 100), description: t("tour.navbar.creators.description")) %>
        </li>
        <li class="nav-item">
          <%= nav_link "collection", Collection.model_name.human(count: 100), collections_path(@filter&.to_params(except: :collection)), text_style: "d-md-none d-lg-inline", id: "nav-link-collections",
                data: tour_attributes(id: "nav-link-collections", title: Collection.model_name.human(count: 100), description: t("tour.navbar.collections.description")) %>
        </li>
        <% if SiteSettings.show_libraries %>
          <% policy_scope(Library).find_each do |library| %>
            <li class="nav-item">
              <%= nav_link(
                    library.icon.presence || "boxes",
                    library.name,
                    models_path({library: library}.merge(@filter&.to_params(except: :library) || {})),
                    title: library.caption
                  )	%>
            </li>
          <% end %>
        <% end %>
      </ul>
      <ul class="navbar-nav col-auto pe-4 align-self-start justify-content-end">
        <li class="nav-item">
          <% if policy(:upload).index? %>
            <div class="btn-group">
              <%= content_tag :button,
                    type: "button",
                    id: "nav-link-upload",
                    class: "btn btn-warning btn-sm mt-1 me-1 dropdown-toggle",
                    data: {
                      bs_toggle: "dropdown"
                    }.merge(tour_attributes(
                      id: "nav-link-upload",
                      title: t(".add_models"),
                      description: t("tour.navbar.add_models.description")
                    )),
                    aria: {
                      expanded: "false"
                    } do
                    safe_join [Icon(icon: "plus-circle"), t(".add_models")], " "
                  end %>
              <ul class="dropdown-menu">
                <li><%= link_to t(".upload"), new_model_path, nofollow: true, class: "dropdown-item" %></li>
                <li><%= link_to t(".import_url"), new_import_path, nofollow: true, class: "dropdown-item" %>
              </ul>
            </div>
          <% end %>
        </li>
        <li class="nav-item">
          <% if policy(:scan).create? %>
            <% if @scan_in_progress %>
              <%= nav_link "", t(".scanning"), activity_path, nofollow: true, style: "btn btn-outline-warning btn-sm me-1 mt-lg-1", icon_style: "spinner-border spinner-border-sm" %>
            <% else %>
              <div class="btn-group">
                <button type="button" data-bs-toggle="dropdown" aria-expanded="false"
                  class="btn btn-warning btn-sm mt-1 me-1 dropdown-toggle">
                  <%= Icon(icon: "radar") %>
                  <%= t ".scan" %>
                </button>
                <ul class="dropdown-menu">
                  <li><%= link_to t(".scan_changes"), scans_path, method: :post, nofollow: true, confirm: "poop", class: "dropdown-item" %></li>
                  <li><%= link_to t(".check_existing"), scans_path(type: :check), method: :post, nofollow: true, class: "dropdown-item" %>
                  <li><%= link_to t(".check_results"), scans_path({type: :check}.merge(@filter.to_params)), method: :post, nofollow: true, class: "dropdown-item" if @filter&.any? %>
                </ul>
              </div>
            <% end %>
          <% end %>
        </li>
        <%- if current_user %>
          <% if policy(Problem).index? && Problem.visible(problem_settings).count > 0 %>
            <li class="nav-item">
              <% severity = max_problem_severity(policy_scope(Problem).all) %>
              <%= nav_link problem_icon(severity),
                    Problem.model_name.human(count: 100),
                    problems_path,
                    title: translate("problems.severities.#{severity}"), # rubocop:todo I18n/RailsI18n/DecorateStringFormattingUsingInterpolation
                    icon_style: "link-#{severity}",
                    text_style: "d-md-none",
                    aria_label: Problem.model_name.human(count: 100) %>
            </li>
          <% end %>
          <% if policy(:activity).index? %>
            <li class="nav-item">
              <%= nav_link "activity", t(".activity"), activity_path, nofollow: true, text_style: "d-md-none" %>
            </li>
          <% end %>
          <% if policy(:settings).index? %>
            <li class="nav-item">
              <%= nav_link "gear", t(".settings"), settings_path, nofollow: true, text_style: "d-md-none" %>
            </li>
          <% end %>
          <% if policy(:user).index? and not policy(:settings).index? %>
            <li class="nav-item">
              <%= nav_link "people", t(".moderator_settings"), settings_users_path, nofollow: true, text_style: "d-md-none" %>
            </li>
          <% end %>
        <% end %>
        <%- unless current_page?(root_path) %>
          <li id="nav-search" class="nav-item ms-1 me-3" data-turbo-permanent>
            <%= form_with url: models_path, method: :get, role: "search" do |f| %>
              <%= f.search_field :q, class: "form-control", placeholder: translate(".search"), aria_label: translate(".search"), aria_describedby: "button-search", value: @query || params[:q] %>
            <% end %>
          </li>
        <% end %>
        <%- if current_user %>
          <%- if SiteSettings.multiuser_enabled? %>
            <li class="nav-item dropdown">
              <%= nav_link "person", t(".account"), edit_user_registration_path, nofollow: true, text_style: "d-md-none", id: "nav-link-preferences",
                    data: {
                      bs_toggle: "dropdown"
                    }.merge(tour_attributes(id: "nav-link-preferences", title: t(".account"), description: t("tour.navbar.account.description"))),
                    aria: {
                      expanded: false
                    } %>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><%= link_to t("devise.registrations.edit.title"), edit_user_registration_path, nofollow: true, class: "dropdown-item" %></li>
                <%- if current_user != SiteSettings.default_user %>
                  <li><hr class="dropdown-divider"></li>
                  <li class="dropdown-header"><%= t(".my_stuff") %></li>
                  <li><%= link_to Model.model_name.human(count: 100), models_path(owner: current_user.to_param), nofollow: true, class: "dropdown-item" %></li>
                  <li><%= link_to Creator.model_name.human(count: 100), creators_path(owner: current_user.to_param), nofollow: true, class: "dropdown-item" %></li>
                  <li><%= link_to Collection.model_name.human(count: 100), collections_path(owner: current_user.to_param), nofollow: true, class: "dropdown-item" %></li>
                <%- end %>
                <%- if SiteSettings.federation_enabled? %>
                  <li><hr class="dropdown-divider"></li>
                  <li class="dropdown-header"><%= t(".social") %></li>
                  <li><%= link_to t("follows.index.title"), follows_path, nofollow: true, class: "dropdown-item" %></li>
                <%- end %>
              </ul>
            </li>
          <% else %>
            <li class="nav-item">
              <%= nav_link "person", t("devise.registrations.edit.title"), edit_user_registration_path, nofollow: true, text_style: "d-md-none", id: "nav-link-preferences",
                    data: tour_attributes(id: "nav-link-preferences", title: t(".account"), description: t("tour.navbar.account.description")) %>
            </li>
          <% end %>
        <% end %>
        <%- if SiteSettings.multiuser_enabled? %>
          <li class="nav-item">
            <%- if current_user %>
              <%= nav_link "box-arrow-right", t(".log_out"), destroy_user_session_path, method: :delete, title: translate(".log_out"), text_style: "d-md-none" %>
            <% else %>
              <%= nav_link "box-arrow-in-right", t(".log_in"), new_user_session_path, title: translate(".log_in"), nofollow: true, style: "btn btn-secondary" %>
            <% end %>
          </li>
        <%- end %>
      </ul>
    </div>
  </div>
<% end %>
